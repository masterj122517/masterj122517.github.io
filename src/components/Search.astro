---
import { getCollection } from 'astro:content';

interface Props {
  query?: string;
}

const { query = '' } = Astro.props;

const allPosts = await getCollection('blog');

const filteredPosts = query
  ? allPosts.filter((post) => {
      const lowerQuery = query.toLowerCase();
      const titleMatch = post.data.title.toLowerCase().includes(lowerQuery);
      const tagMatch = post.data.tags.some((tag) => 
        tag.toLowerCase().includes(lowerQuery)
      );
      const categoryMatch = post.data.category.toLowerCase().includes(lowerQuery);
      return titleMatch || tagMatch || categoryMatch;
    })
  : allPosts;
---

<div id="search-container">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-16">
    <div class="mb-8">
      <input
        type="text"
        id="search-input"
        placeholder="Search by title, tags, or category... (Press Ctrl/Cmd + K)"
        value={query}
        class="w-full px-4 py-3 bg-surface border border-border rounded-lg text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent transition-all"
        autofocus
      />
    </div>

    <div id="search-results">
      <div id="results-count" class="text-text-muted mb-6">
        {query
          ? `${filteredPosts.length} result${filteredPosts.length !== 1 ? 's' : ''} found for "${query}"`
          : `Showing all ${allPosts.length} posts`
        }
      </div>

      {filteredPosts.length > 0 ? (
        <div class="space-y-4 min-h-[200px]">
          {filteredPosts.map((post) => (
            <article class="bg-surface rounded-lg p-6 hover:bg-surface-hover transition-colors duration-200 border-b border-border last:border-b-0">
              <a href={`/blog/${post.slug}`} class="block">
                <h3 class="text-xl font-bold text-text mb-2 hover:text-accent transition-colors duration-200">{post.data.title}</h3>
                <p class="text-text-muted mb-3">{post.data.description}</p>
                <div class="flex items-center justify-between text-sm text-text-muted">
                  <span>{post.data.date.toLocaleDateString()}</span>
                  <div class="flex gap-2">
                    {post.data.tags.map((tag) => (
                      <span class="px-2 py-1 bg-accent/10 text-accent rounded-full text-xs">{tag}</span>
                    ))}
                  </div>
                </div>
              </a>
            </article>
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <p class="text-text-muted text-lg">
            No posts found matching your search.
          </p>
          <p class="text-text-muted text-sm mt-2">
            Try different keywords or browse all posts.
          </p>
        </div>
      )}
    </div>
  </div>
</div>

<script>
  const searchInput = document.getElementById('search-input');
  
  if (searchInput) {
    searchInput.focus();
    
    searchInput.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      if (!target) return;
      
      const query = target.value;
      
      if (query.trim() === '') {
        window.location.href = '/search';
        return;
      }
    });
  }
</script>